<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Citas M√©dicas</title>
    <link rel="stylesheet" href="./css/Doctors.css">
    <link rel="stylesheet" href="./css/Citas.css">
    <link rel="stylesheet" href="./css/FrmPaciente.css">
    <link rel="stylesheet" href="./css/Calendario.css">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.3/dist/sweetalert2.min.css" rel="stylesheet">

</head>
<body>
    <div class="container">
        <div class="header">
            <h1><img class="btMainLogo" data-hw="3.6708860759494" src="https://clinicalosfresnos.com.pe/wp-content/uploads/2024/01/LogoSinFondoHome.png" alt="Cl√≠nica Los Fresnos"> </h1>
            <p class="titulo" id="titulo">Seleccione una Especialidad
            </p>
        </div>

        
        <div id="specialties-view" class="view active">
            <div class="grid-especialidades" id="grid-especialidades"></div>
        </div>

        <!-- Vista 2: M√©dicos -->
        <div id="doctores-view" class="view">
            <button class="back-btn" onclick="showView('specialties')">‚Üê Volver a Especialidades</button>
            <h2 style="color: white; margin-bottom: 20px;" id="specialty-title"></h2>
            <div class="doctors-grid" id="doctors-grid"></div>
        </div>

        <!-- Vista 3: Calendario -->
        <div id="calendar-view" class="view">
            <button class="back-btn" onclick="showView('doctores')">‚Üê Volver a M√©dicos</button>
            
            <div class="calendar-container">
                <div class="calendar-header">
                    <h3>üìÖ Horarios M√©dicos - Diciembre 2024</h3>
                </div>
                
            <div class="schedule-container" id="scheduleContainer">
                <div class="calendario">
                    <div class="calendario-header">
                        <button id="prev-month">‚Äπ</button>
                        <div id="month-year"></div>
                        <button id="next-month">‚Ä∫</button>
                    </div>
                    <div class="calendar-body">
                        <div class="calendar-weekdays">
                           
                        </div>
                        <div class="dias-calendario">
                          
                        </div>
                    </div>
                </div>
                <div class="doctor-horarios" id="doctorHorarios">
                    
                </div>
                  
               
            </div>
        </div>
    </div>
    

    <div class="modal" id="modalPaciente">
        <div class="modal-content">
          
            <div class="modal-header">
                <div>
                    <h2>Datos del Paciente</h2>
                    <a href="#" class="link-reniec">üîç Identidad Verificada (RENIEC)</a>
                </div>
                <button class="btn-cerrar" onclick="CerrarFormulario()">&times;</button>
            </div>

            <!-- Body del modal -->
            <div class="modal-body">
                <div class="section">
                    <div class="section-title">
                        üìÑ Validaci√≥n de Identidad
                    </div>
                    <input type="hidden" id="txtIdHorario"/>
                    <input type="hidden" id="txtIdMedico"/>
                    <div class="row">
                        <div class="form-group">
                            <label>Tipo de Documento</label>
                            <select id="tipoDoc">
                                <option>DNI</option>
                                <option>Carnet de Extranjer√≠a</option>
                                <option>Pasaporte</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>N√∫mero de Documento</label>
                            <div class="input-group">
                                <input type="text" id="txtDocumento" placeholder="74692318" name="documento" required />
                                
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group full">
                    <label>Nombres Completos</label>
                    <input type="text" placeholder="üë§" id="txtNombres" name="nombres" required />
                </div>

                <div class="row">
                    <div class="form-group">
                        <label>Apellido Paterno</label>
                        <input type="text" placeholder="üë§" id="txtApellidoPaterno"  name="ApellidoPaterno" required />
                    </div>
                    
                    <div class="form-group">
                        <label>Apellido Materno</label>
                        <input type="text" placeholder="üë§ " id="txtApellidoMaterno"  name="ApellidoMaterno" required />
                    </div>
                </div>

                <div class="form-group full">
                    <label>Correo Electr√≥nico</label>
                    <input type="email" placeholder="‚úâÔ∏è juan@ejemplo.com" id="txtCorreo" name="correo" required />
                </div>

                <div class="form-group full">
                    <label>Celular (Per√∫)</label>
                    <div class="input-group">
                        <select>
                            <option>üì± +51</option>
                        </select>
                        <input type="tel" id="txtCelular" placeholder="900 000 000" name="celular" required />
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="CerrarFormulario()">‚Üê Atr√°s</button>
                <button class="btn btn-primary" onclick="CrearCita()">Genera Cita ‚Üí</button>
            </div>
        </div>
    </div>
     <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.3/dist/sweetalert2.all.min.js"></script>
    <script>
        // Datos
     
        let currentSpecialty = null;
        let currentDoctor = null;

        // Mostrar especialidades
        function renderSpecialties() {

            
            const gridEspecialidades = document.getElementById('grid-especialidades');
            /*consuta fetch API*/

            fetch("https://api-rest-ventas-production.up.railway.app/api/Especialidades")
                
                .then(response => response.json())
                .then(data => {
                 
                
                gridEspecialidades.innerHTML = data.map(data => `
                    <div class="especialidad" onclick="ObtenerMedicosEspecialidad(${data.id_especialidad})">
                        <div class="especialidad-icon">${data.id_especialidad ===1? "‚ù§Ô∏è":data.id_especialidad === 2? "üë©‚Äç‚öïÔ∏è":data.id_especialidad === 3? "üß∏ü©π": data.id_especialidad === 4? "ü¶∑":""}</div>
                        <h3>${data.Descripcion}</h3>
                        
                    </div>
                `).join('');

                })
                   
           
        }

        // Seleccionar especialidad
       async function ObtenerMedicosEspecialidad(id) {
       
        var doctores = document.getElementById('doctors-grid');
         doctores.innerHTML=""
        try {
            const response = await fetch(`https://api-rest-ventas-production.up.railway.app/api/MedicosEspecialidad/${id}`);
            /*esperar que se convierta en json ya que es un fucnion asincrona*/

            const data = await response.json();
            if(data.length>0){
              
                    
            doctores.innerHTML = data.map(doctor => {
                    
                    return `
                        <div class="doctor-card" onclick="SelecionarDoctor(${doctor.id_medico})">
                            <div class="doctor-header">
                                <div class="doctor-avatar">
                                <img class="wp-image-5014 aligncenter" src="https://clinicalosfresnos.com.pe/wp-content/uploads/2023/09/Doc1-640x638.png" alt="" width="50" height="50" srcset="https://clinicalosfresnos.com.pe/wp-content/uploads/2023/09/Doc1-640x640.png 640w, https://clinicalosfresnos.com.pe/wp-content/uploads/2023/09/Doc1-160x160.png 160w, https://clinicalosfresnos.com.pe/wp-content/uploads/2023/09/Doc1-768x766.png 768w, https://clinicalosfresnos.com.pe/wp-content/uploads/2023/09/Doc1-320x320.png 320w, https://clinicalosfresnos.com.pe/wp-content/uploads/2023/09/Doc1.png 793w" sizes="(max-width: 50px) 100vw, 50px">    
                                </div>
                                <div class="doctor-info">
                                    <h3>DR ${doctor.Apellidos}, ${doctor.Nombres}</h3>
                                    <p>${doctor.Especialidad}</p>
                                </div>
                            </div>
                            
                        </div>
                    `;
                }).join('');
              
                showView('doctores');

            }
            else {
                
              doctores.innerHTML="No existe doctores"
               showView('doctores');
          
            }
            } catch (error) {

            throw new Error('Hubo un error al obtener los datos:', error);
        }
          
        
           
          
          
        }


        
      async function SelecionarDoctor(IdDoctor){
             
        
           var data= await fetch(`https://api-rest-ventas-production.up.railway.app/api/HorariosMedico/${IdDoctor}`)
           var result= await data.json();
           
            MostrarCalendario(result,IdDoctor);
        }
   
      
        function MostrarCalendario(result,IdDoctor){

              if(result.length>=0){
                
              
                var Fecha = new Date();
                
                var mesNumero = Fecha.getMonth();
                    
                var a√±oNumero = Fecha.getFullYear();
                /*limpiar cuando se da click en mostrar el calendario*/
                var  HorariosDoctorEspecialista=document.getElementById("doctorHorarios")
                HorariosDoctorEspecialista.innerHTML=""
                diasCalendarios.innerHTML = '';
                renderCalendar(mesNumero,a√±oNumero,IdDoctor);

               
                showView('calendar');
              }
              else {
                  alert("No existe horarios para este medico")
              }
             
        }
        // Seleccionar m√©dico
        function selectDoctor(specialtyId, doctorId) {
            const doctorList = doctors[specialtyId];
            currentDoctor = doctorList.find(d => d.id === doctorId);
            renderCalendar();
            showView('calendar');
        }


   

        // Cambiar vista
        function showView(viewName) {

            document.querySelectorAll('.view').forEach(view => {
                view.classList.remove('active');
            });
            document.getElementById(`${viewName}-view`).classList.add('active');
        }


        function ReservarCita(id_horario,idMedico,cupos){
           
            if(cupos<=0) {

               
               alert("No existe cupos")

            }
            else {
               


                document.getElementById("modalPaciente").classList.add("activar")


                document.getElementById("txtIdHorario").value=id_horario
                
                
            


            }
           
        }


        function CerrarFormulario(){

               document.getElementById("modalPaciente").classList.remove("activar")
        }

      async function CrearCita(){

        try {

        /* document.getElementById("modalPaciente").classList.remove("activar")*/

                var id_Horario=parseInt(document.getElementById("txtIdHorario").value)
                var PacienteNombres=document.getElementById("txtNombres").value;
                var apellidoPaterno=document.getElementById("txtApellidoPaterno").value;
                var apellidoMaterno=document.getElementById("txtApellidoMaterno").value;
                var PacienteApellidos=apellidoPaterno + " "  + apellidoMaterno
                var TipoDocumento=document.getElementById("tipoDoc").value;
                var NumeroDocumento=document.getElementById("txtDocumento").value;
                var Celular=document.getElementById("txtCelular").value
                var Correo=document.getElementById("txtCorreo").value
            

            if(PacienteApellidos==="" || apellidoMaterno==="" || apellidoPaterno==="" || TipoDocumento==="" || NumeroDocumento==="" || Celular==="" || Correo===""){
                alert("Ingresar todos los campos solicitados")
                return
            }
            if(!validateEmail(Correo)){
                 alert("Ingresa un correo Correcto")

                 return
            }
            if(!validaDNI(NumeroDocumento)){

                 alert("Ingresar el numero de Dni correcto")
                 return;
            }
                const Cita={
                    id_Horario,
                    PacienteNombres,
                    PacienteApellidos,
                    TipoDocumento,
                    NumeroDocumento,
                    Celular,
                    Correo
                }
            

            const response = await fetch("https://api-rest-ventas-production.up.railway.app/api/Citas", {
                method: "POST",
                body: JSON.stringify(Cita),
                headers: {
                    "Content-Type": "application/json"
                }   
            });

            const result = await response.json();
                if(result.id>0) {
                 
                Swal.fire({
                icon: 'success',
                title:  `Reserva Cita `,
                html:   `
                        <div style="text-align: left; padding: 20px; font-family: Arial, sans-serif;">
                            <div style="background-color:rgb(59 130 246 / 0.5); 
                                        color: white; 
                                        font-weight:800px;
                                        padding: 15px; 
                                        border-radius: 10px; 
                                        margin-bottom: 20px;
                                        text-align: center;">
                            <h3 style="padding: 5px 0; font-size: 20px;">
                               ¬°Reserva Confirmada! 
                            </h3>
                             <h3 style="margin: 0; font-size: 20px;">
                                ${Cita.PacienteNombres} ${Cita.PacienteApellidos}
                            </h3>
                           
                            </div>
                            
                            <div style="background-color: #f8f9fa; 
                                        padding: 15px; 
                                        border-radius: 8px; 
                                        border-left: 4px solid #667eea;">
                            
                            <p style="margin: 10px 0; color: #555; font-size: 14px;">
                                Hemos enviado un correo de confirmaci√≥n a.
                            </p>
                            <p style="margin: 10px 0; color: #333;">
                                <strong>üìß Correo:</strong> 
                                <span style="color: #667eea;">${Cita.Correo}</span>
                            </p>
                            </div>
                            
                            <div style="margin-top: 15px; 
                                        padding: 12px; 
                                        background-color: #d4edda; 
                                        border-radius: 6px;
                                        border: 1px solid #c3e6cb;">
                            <p style="margin: 0; color: #155724; font-size: 13px;">
                                ‚úÖ Tu cita ha sido registrada correctamente en el sistema
                            </p>
                            </div>
                        </div>
                        `,
                confirmButtonText: "Ir al Inicio",
              
                }).then(async(result)=>{
                   if(result.isConfirmed) {


                  
                    document.getElementById("modalPaciente").classList.remove("activar")
                    /*enviar la data*/

               
                    LimpiarDatos();               
                    showView('specialties')
                
                   }

                })


              const resultado = await fetch("https://api-rest-ventas-production.up.railway.app/EnviarCorreo", {
                method: "POST",
                body: JSON.stringify(Cita),
                headers: {
                    "Content-Type": "application/json"
                }   
                }).then(()=>{
                    alert("Se ha enviado correctamnete al correo")
                })
              
                

            
                }

                else {

                window.alert("Ingresar correctamente los datos")
                }
                



        } catch(Error){

        alert("Error",Error)
        }       
                
                
            
        }
        // Inicializar
        renderSpecialties();

        function LimpiarDatos(){


                
                document.getElementById("txtNombres").value="";
                document.getElementById("txtApellidoPaterno").value="";
                document.getElementById("txtApellidoMaterno").value="";
                document.getElementById("tipoDoc").value="";
                document.getElementById("txtDocumento").value="";
                document.getElementById("txtCelular").value=""
                document.getElementById("txtCorreo").value=""
        }

        function ModalResultadoCita(cita) {
            return  `
            <div style="max-width: 450px; margin: 0 auto; background-color: #ffffff; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.15); font-family: Arial, sans-serif; border: 1px solid #e0e0e0;">
                
            
                <div style="background-color: #2196F3; padding: 35px 25px; text-align: center; color: white;">
                    <div style="width: 70px; height: 70px; background-color: rgba(255,255,255,0.2); border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 15px;">
                        <div style="font-size: 40px;">‚úì</div>
                    </div>
                    <h1 style="margin: 0; font-size: 24px; font-weight: 600;">¬°Reserva Confirmada!</h1>
                </div>
                <div style="padding: 30px 25px;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <p style="margin: 0; color: #333; font-size: 15px; line-height: 1.6;">
                            <strong>${cita.PacienteNombres} ${cita.PacienteApellidos}</strong>, tu reserva ha sido registrada exitosamente.
                        </p>
                    </div>
                    <div style="background-color: #E3F2FD; padding: 18px; border-radius: 8px; border-left: 4px solid #2196F3; text-align: center; margin-bottom: 20px;">
                        <p style="margin: 0 0 6px 0; color: #1565C0; font-size: 13px;">
                            üìß Detalles enviados a:
                        </p>
                        <p style="margin: 0; color: #0D47A1; font-size: 15px; font-weight: bold;">
                            ${cita.Correo}
                        </p>
                    </div>       
                <div style="background-color: #FFF3E0; padding: 15px; border-radius: 8px; border-left: 4px solid #FF9800; margin-bottom: 25px;">
                        <p style="margin: 0; color: #E65100; font-size: 13px; line-height: 1.5;">
                            <strong>üí° Importante:</strong> Llega 10 minutos antes de tu hora reservada.
                        </p>
                </div>       
                <div style="text-align: center;">
                        <a href="#" style="display: inline-block; background-color: #2196F3; color: white; text-decoration: none; padding: 12px 32px; border-radius: 6px; font-weight: 600; font-size: 14px;">
                            Volver al Inicio
                        </a>
                </div>        
                </div>
                <div style="background-color: #FAFAFA; padding: 18px; text-align: center; border-top: 1px solid #E0E0E0;">
                    <p style="margin: 0; color: #757575; font-size: 11px; line-height: 1.4;">
                        ¬© 2025 Cl√≠nica Los Fresnos<br>Todos los derechos reservados
                    </p>
                </div>
                
            </div>
                        
            `
        }

    /*Javascript para calendarios*/
     
        const diasCalendarios = document.querySelector('.dias-calendario');
        const monthYear = document.getElementById('month-year');
        const prevMonthBtn = document.getElementById('prev-month');
        const nextMonthBtn = document.getElementById('next-month');
        var Medico=null
        var FechaActual = new Date();

        var currentMonth = FechaActual.getMonth();
            
        var currentYear = FechaActual.getFullYear();
        const months = [
            'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
            'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
        ];

    async function renderCalendar(month=currentMonth, year=currentYear,IdMedico) {
        
            Medico=IdMedico
            diasCalendarios.innerHTML = '';
            monthYear.textContent = `${months[month]} ${year}`;

            /*obtener el primero dia de un mes el numero de dia entre sema√±a*/
            const primerDiaSemana = new Date(year, month, 1).getDay();

            // Get the number of days in the month
            const diasMesActual = new Date(year, month + 1, 0).getDate();
        
            const obtenerFecha=await fetch(`https://api-rest-ventas-production.up.railway.app/api/HorariosMedico/${IdMedico}`)
            
            const data=await obtenerFecha.json()
            
            
           if(data.length>0) {

           
            /*elementos repetidos*/
            const fechas=data.map((fecha)=>fecha.FechaHorario)
        
     
            var FechasCitaMedicos = [...new Set(fechas)];
            

           FechasCitaMedicos = FechasCitaMedicos.map(fecha => 
                new Date(fecha).toISOString().split("T")[0]
            );
           
            // Create blanks for days of the week before the first day
            for (let i = 0; i < primerDiaSemana; i++) {
                const blank = document.createElement('div');
                diasCalendarios.appendChild(blank);
            }
            
            // Populate the days 0 domingoo lunes1 martes 2 miercoles 3 jueves 4 viernes 5 sabado 6
            for (let i = 1; i <= diasMesActual; i++) {

                
                const day = document.createElement('div');
                const FechaCalendario=new Date(year,month,i)
      
                day.textContent = i;
                
                FechasCitaMedicos.forEach((fechaMedico)=>{
                    
                    /*poenr al estandar internacion en string separar split  como la fecha esta a la izquierda y la hora a l
                    la derecha entocnes tiene que cojees este comando*/
                    
                    let Fecha=FechaCalendario.toISOString().split("T")[0]
                   

                    if(fechaMedico===Fecha) {
                       
                       day.style.backgroundColor = "#4CAF50";
                       day.style.color = "white";
                       day.style.fontWeight = "bold";
                       day.style.borderRadius = "8px";
                       day.style.boxShadow = "0 4px 8px rgba(76, 175, 80, 0.3)";
                       day.style.transform = "scale(1.05)";
                       day.style.cursor = "pointer";
                       day.addEventListener("click",function(event){
                       ObtenerCitasMedicos(Fecha,IdMedico)
                       event.preventDefault();
                        })
                    }
                    
                
                })    
            
                diasCalendarios.appendChild(day);
            
            }
        }
    }

    /*botones para siguiente mes y anterior messs*/
    prevMonthBtn.addEventListener('click', () => {
       
        currentMonth--;
        if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        }
        renderCalendar(currentMonth, currentYear,Medico);
    });

    nextMonthBtn.addEventListener('click', () => {
       
        currentMonth++;
        if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        }
        renderCalendar(currentMonth, currentYear,Medico);
        
    });
    
   async function ObtenerCitasMedicos(FechaHorario,IdMedico){
    
    var HorariosDoctor=document.getElementById("doctorHorarios")
     HorariosDoctor.innerHTML=""
        const data={
            FechaHorario,
            IdMedico
        } 
    
        const resultado=await fetch("https://api-rest-ventas-production.up.railway.app/api/HorariosMedicoFecha",{
        method:"POST",
        headers: {
        'Content-Type': 'application/json'

        },
        body: JSON.stringify(data)
        });
        const resultadoFinal=await resultado.json();
        console.log(resultadoFinal)
        /*resetar el html*/
       
        resultadoFinal.forEach((horario)=>{
         const card = document.createElement('div');
                card.className = 'horario-card';
                 
                var date = new Date(horario.FechaHorario);
                const fecha=date.toLocaleDateString("es-PE",{
                timeZone: 'UTC',
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
                })
                /*card.onclick = () => showSchedule(horario.id_medico);*/
                card.innerHTML = `
                <div class="horario-header">
                <div class="horario-icon">üë®‚Äç‚öïÔ∏è</div>
                <div class="doctorHorario-info">
                    <h3>Dr.${horario.Doctor}</h3>
                    <span class="specialty">${horario.Especialidad}</span>
                </div>
                </div>
                <div class="Horario-card-body">
                    <div class="infoHorario">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        <span><strong>${fecha}</strong></span>
                    </div>
                    <div class="infoHorario">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span>${horario.HoraInicio} - ${horario.HoraFin}</span>
                    </div>
                    <div class="availability" id="cupos">${horario.Cupos} Espacios Disponibles</div>
                </div>
                <div class="cardHorario-footer">
                   <button class="btn" onclick="ReservarCita(${horario.id_Horario}, ${horario.id_medico}, ${horario.Cupos})">
                    Reservar Cita
                </button>
                </div>
                `;
                HorariosDoctor.appendChild(card);

        })

    }
      function validateEmail(email) {
        const pattern = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+.[a-zA-Z]{2,6}$/;
        return pattern.test(email);
        }

    function validaDNI(dni){
        var ex_regular_dni; 
        ex_regular_dni = /^\d{8}(?:[-\s]\d{4})?$/;
        var resultado=ex_regular_dni.test(dni)
        return resultado
    }
    
    </script>
    
</body>
</html>