<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
        
        <link href="../css/Modal.css" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>

    </script>
 

    <style>
        body {
            background:#fff;
            min-height: 100vh;
            padding: 40px 0;
        }
        .vista {
            display: none;
        }
        .vista.activar{
            display: block;
        }
        /*vista login*/
        .login-card {
            border: 2px solid hsla(0, 0%, 1%, 0.226);
            box-shadow: 0 4px 6px rgba(15, 15, 15, 0.08);
        }
        a{
            text-decoration: none;
            border: 1px solid black;
        }
        .search-box:focus {
            outline: none !important;
            box-shadow: none !important;
            border-color: #ced4da !important; /* Color del borde normal */
        }
        .titulo-header{
            text-transform: uppercase;
            margin-bottom: 15px;
            
        }
    </style>
</head>
<body>
<div class="modal fade" id="modalMedico">
    <div class="modal-dialog">
        <div class="modal-content">
            
            <div class="modal-header">
                <h5 class="modal-title">Editar M√©dico y Horarios</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            
            <div class="modal-body">
                <form>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">NOMBRE COMPLETO</label>
                            <input type="text" class="form-control" id="ModalMedico">
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label">ESPECIALIDAD</label>
                            <select class="form-select">
                                <option value="1">Cardiolog√≠a</option>
                                <option value="2">Ginecologia</option>
                                <option>Traumatolog√≠a</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">N√öMERO CMP</label>
                            <input type="text" class="form-control" value="12456">
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Horario de Atencion</label>
                            <input type="date" class="form-control" id="txtHorarioAtencion">
                        </div>
                        <input type="hidden" id="txtIdHorario">
                    </div>
                    
                    <hr>
                    
                    <h6 class="mb-3">‚è∞ Configuraci√≥n de Horario y Cupos</h6>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">HORA INICIO</label>
                            <input type="time" class="form-control"  id="txtHorarioInicio">
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label class="form-label">HORA FIN</label>
                            <input type="time" class="form-control"  id="txtHoraFin">
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label class="form-label">CUPOS DIARIOS</label>
                            <input type="number" class="form-control" id="txtCupos">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn btn-primary" onclick="GuardarCambios(event)">Guardar</button>
                        </div>
                    </div>
                </form>
            </div>
            
      
            
        </div>
    </div>
</div>
<div class="modal fade" id="modalHorario">
    <div class="modal-dialog">
        <div class="modal-content">
            
            <div class="modal-header">
                <h5 class="modal-title">Registro de Horario M√©dico</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            
            <div class="modal-body">
                <form id="horarioForm">
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label class="form-label" for="especialidad">Especialidad</label>
                            <select class="form-select" id="especialidad" name="especialidad" required onchange="seleccionarMedico(event)">
                              
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 mb-3" for="cbMedicos">
                            <label class="form-label" for="cbMedicos">Medicos</label>
                            <select class="form-select" id="cbMedicos" name="cbMedicos" required>
                              
                            </select>
                        </div>
                    </div>
                      <div class="row">
                       <div class="col-md-12 mb-3">
                            <label class="form-label" for="fechaAtencion">Fecha Atencion :</label>
                            <input type="date" class="form-control" name="fechaAtencion" id="fechaAtencion" required>
                        </div>
                    </div>
                    <div class="row">
                       <div class="col-md-12 mb-3">
                            <label class="form-label" for="Cupos">Cupos</label>
                            <input type="number" class="form-control" name="Cupos" id="Cupos" required>
                        </div>
                    </div>
                    <div class="row">
                       <div class="col-md-6 mb-3">
                            <label class="form-label" for="horaInicio">Hora Inicio:</label>
                            <input type="time" class="form-control" name="fechaAtencion" id="horaInicio" required>
                        </div>
                         <div class="col-md-6 mb-3">
                            <label class="form-label" for="horaFin">Hora Fin:</label>
                            <input type="time" class="form-control" name="fechaAtencion" id="horaFin" required>
                        </div>
                    </div>
                    <div class="modal-footer d-flex justify-content-center">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" onclick="CrearHorarioMedico(event)">Crear Horario</button>
                    </div>
                    
                </form>
            </div>  
            
          
            
        </div>
    </div>
</div>

<div class="vista" id="login-vista">
       <div class="container text-dark vh-100">
        <div class="row h-100 justify-content-center align-items-center">
            <div class="col-lg-5 col-md-8">
                <div class="login-card p-5 rounded-4">
                    <h4 class="mb-4 text-dark text-center text-uppercase">Acceso Administrativo</h4>
                    <form action id="frmLogin">
                        <div class="mb-4">
                            <span class="mb-2">USUARIO</span>
                            <input type="text" class="form-control border-0" placeholder="üë§ Ingrese Usuario" id="txtUsuario">
                        </div>
                        <div class="mb-4">
                            <span class="mb-3">CONTRASE√ëA</span>
                            <input type="password" class="form-control border-0" placeholder="üîí contrase√±a" id="txtPassword">
                        </div>
                        <div class="d-grid mb-2">
                            <button type="submit" class="btn btn-primary btn-login rounded-3 fw-semibold">Ingresar</button>
                        </div>
                       
                    </form>
                </div>
            </div>
        </div>
    </div>

</div>


<div class="vista container" id="citas-vista">
        <div class="main-card mx-auto" style="max-width: 1200px;">
            <!-- Header -->
            <div class="header-section">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="titulo-header">
                        <h2 class="mb-1">Panel de Administraci√≥n</h2>
                    </div>
                    <a  class="btn btn-success btn-sm" onclick="newNuevoHorario(event)">
                        <i class="bi bi-plus-lg me-1"></i>Agregar Nuevo
                    </a>
                </div>
            </div>

            <!-- Filtro -->
            <div class="filter-section">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="input-group">
                            <span class="input-group-text bg-white border-end-0">
                                <i class="fas fa-search text-muted"></i>
                            </span>
                            <input type="text" 
                                   id="searchInput" 
                                   class="form-control search-box border-start-0" 
                                   placeholder="Buscar..."/>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabla -->
            <div class="table-responsive">
                <table class="table ttable-striped table-hove" id="tablaRegistros">
                    <thead class="table-light">
                        <tr>
                                <th scope="col" class="px-4 py-3 text-uppercase text-muted" style="font-size: 0.75rem; font-weight: 600;">M√©dico</th>
                                <th scope="col" class="px-4 py-3 text-uppercase text-muted" style="font-size: 0.75rem; font-weight: 600;">Especialidad</th>
                                <th scope="col" class="px-4 py-3 text-uppercase text-muted" style="font-size: 0.75rem; font-weight: 600;">Fecha Horario</th>
                                <th scope="col" class="px-4 py-3 text-uppercase text-muted" style="font-size: 0.75rem; font-weight: 600;">Hora</th>
                                <th scope="col" class="px-4 py-3 text-uppercase text-muted text-center" style="font-size: 0.75rem; font-weight: 600;">Cupos</th>
                                <th scope="col" class="px-4 py-3 text-uppercase text-muted text-center" style="font-size: 0.75rem; font-weight: 600;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody >
                        
                    </tbody>
                </table>
            </div>

            <!-- Footer -->
            <div class="p-3 bg-light border-top">
                <div class="d-flex justify-content-between align-items-center">
                    <span class="text-muted">Mostrando <span id="countRegistros">5</span> registros</span>
                    <nav>
                        <ul class="pagination mb-0">
                            <li class="page-item disabled">
                                <a class="page-link" href="#">Anterior</a>
                            </li>
                            <li class="page-item active"><a class="page-link" href="#">1</a></li>
                            <li class="page-item"><a class="page-link" href="#">2</a></li>
                            <li class="page-item"><a class="page-link" href="#">3</a></li>
                            <li class="page-item">
                                <a class="page-link" href="#">Siguiente</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
</div>

<script src="../js/Horario.js"></script>
<script>

   /*variablesgloblaes*/
   showView("login")
  var valorHorario=null
   
    
    /*login*/
    var filtro=document.getElementById("searchInput");
    document.getElementById("frmLogin").addEventListener("submit",(event)=>{
       
        var usuario=document.getElementById("txtUsuario").value;
        var contrase√±a=document.getElementById("txtPassword").value;
        
         if(usuario="ecueva" && contrase√±a=="1234"){
            
        
            CargarHtmlHorarios()
            showView("citas")
         }
         else {
            alert("Incorrecta   ")
         }

        
        
        event.preventDefault();
    })
     
    function showView(viewName) {

            document.querySelectorAll('.vista').forEach(view => {
                view.classList.remove('activar');
            });
            document.getElementById(`${viewName}-vista`).classList.add('activar');
    }


    var resultadosHorariosMedicos=null;
    async function ObtenerCitas(){

        const data=await fetch("https://api-rest-ventas-production.up.railway.app/api/Horarios");
        const resultado=await data.json();
        return resultado  
    }

   async function CargarHtmlHorarios(){

       var search=filtro.value;
       var registroHorarios=await ObtenerCitas();
       var horariosMedicos=document.querySelector("#tablaRegistros tbody")


     
       var registrosHorariosFinal=registroHorarios.filter((horario)=>{
         if(search==="") {
            return horario
         }else if(horario.Medico.toLowerCase().includes(search.toLowerCase())){
            return horario

         }

       })
       
       /*actual√±ziar*/
      registrosHorariosFinal=registrosHorariosFinal.map((horario)=>
       ({ ...horario,FechaHorario:horario.FechaHorario.split("T")[0] }))

      
       if(registrosHorariosFinal.length>0) {
       horariosMedicos.innerHTML=""
         
   
       let dataInnerHtml=registrosHorariosFinal.map((horario)=>{
        
        

           return `
           <tr>
                <td class="px-4 py-3">
                <div class="d-flex align-items-center">
                    <div class="doctor-avatar me-3">
                        <i class="bi bi-person-fill"></i>
                    </div>
                    <div>
                        <div class="fw-semibold">Dr. ${horario.Medico}</div>
                        <small class="text-muted">CMP: 12456</small>
                    </div>
                </div>
            </td>
            <td class="px-4 py-3">
                <span class="badge badge-specialty" style="background-color: #e7f0ff; color: #2563eb;">${horario.Especialidad}</span>
            </td>
            
            <td class="px-4 py-3">${horario.FechaHorario.split("-").reverse().join("-")}</td>
            <td class="px-4 py-3">${horario.HoraInicio}-${horario.HoraFin}</td>
            <td class="px-4 py-3 text-center">
                <span class="badge bg-success px-3 py-2">${horario.Cupos}</span>
            </td>
            <td class="px-4 py-3 text-center">
                <button class="btn btn-sm btn-outline-primary me-1" onclick="EditarCampos(${horario.id_Horario})">
                  Editar
                </button>
                <button class="btn btn-sm btn-outline-danger">
                   Eliminar
                </button>
                </td>
            </tr>
           `
       }).join("");

       horariosMedicos.innerHTML=dataInnerHtml
     }
     else {
        horariosMedicos.innerHTML="<h3>No se encontraron m√©dicos </h3>"
     }

    }

   filtro.addEventListener("keyup",(event)=>{

      
      CargarHtmlHorarios();
   })


   /*variable global*/
   var modalEditarHorario= new bootstrap.Modal(document.getElementById("modalMedico"))


 async  function EditarCampos(IdHorario){
    
    const data=await fetch(`https://api-rest-ventas-production.up.railway.app/api/Horario/${IdHorario}`)
    const horario=await data.json();
 
    const horarioFinal=horario[0]
        document.getElementById("txtIdHorario").value=horarioFinal.id_Horario

        document.getElementById("txtHorarioInicio").value=horarioFinal.HoraInicio
        document.getElementById("txtHoraFin").value=horarioFinal.HoraFin
        document.getElementById("txtCupos").value=horarioFinal.Cupos
        document.getElementById("ModalMedico").value=horarioFinal.Medico
         document.getElementById("ModalMedico").readOnly =true
        const fechaInput = horarioFinal.FechaHorario
        const fechaArray=fechaInput.split("T")
        document.getElementById("txtHorarioAtencion").value=fechaArray[0]
        /*mostrar el modal*/
     modalEditarHorario.show();
   }

/*seuguna parte */ 

var modalHorario=document.getElementById("modalHorario");

var modalNuevoHorario= new bootstrap.Modal(modalHorario)
function newNuevoHorario(event){

     MostrarEspecialidad()
    
   modalNuevoHorario.show()
    event.preventDefault();
    

}
 
 async function MostrarEspecialidad(){

      var result= await fetch("https://api-rest-ventas-production.up.railway.app/api/Especialidades")
      var especialidades=await result.json();
      var cbEspecialidades=document.getElementById("especialidad")
      cbEspecialidades.innerHTML=""
       especialidades.forEach((especialidad)=>{
                
                const optionElement = document.createElement("option"); 
                optionElement.value = especialidad.id_especialidad; 
                optionElement.textContent = especialidad.Descripcion;
                cbEspecialidades.appendChild(optionElement);
      })
    }
    async function seleccionarMedico(event){
        
        var medicos=document.getElementById("cbMedicos")
        medicos.innerHTML=""
        let  cbEspecialidades=document.getElementById("especialidad")


        var EspecialidadDescripcion=event.target.options[cbEspecialidades.selectedIndex].text
        var IdEspecialidad=parseInt(event.target.value)
        const response = await fetch(`https://api-rest-ventas-production.up.railway.app/api/MedicosEspecialidad/${IdEspecialidad}`);
        const medicosEspecialidad=await response.json();

        
         if(medicosEspecialidad.length>0) {
             medicosEspecialidad.forEach((especialidad)=>{
                
                const optionElement = document.createElement("option"); 
                optionElement.value = especialidad.id_medico; 
                optionElement.textContent = especialidad.Nombres;
                medicos.appendChild(optionElement);
            })

            }
            else {

                alert("No existe medicos para esta especialidad")
            }
            

         event.preventDefault();
    }

  async function RegistrarHorario(){

         var id_medico=document.getElementById("cbMedicos").value;
        var FechaHorario =document.getElementById("fechaAtencion").value;
        var Cupos =document.getElementById("Cupos").value;
        var HoraInicio =document.getElementById("horaInicio").value;
        var HoraFin =document.getElementById("horaFin").value;

         const Horario={
            id_medico,
            FechaHorario,
            Cupos,
            HoraInicio,
            HoraFin
         }
         
            const response = await fetch("https://api-rest-ventas-production.up.railway.app/api/Horario", {
                method: "POST",
                body: JSON.stringify(Horario),
                headers: {
                    "Content-Type": "application/json"
                }   
            });

            const result = await response.json();
            console.log(result)
            if(result.id>0){
                alert(result.mensaje)
                Limpiar();
                CargarHtmlHorarios()
                showView("citas")
                modalNuevoHorario.hide()
               
            }
            else {
                alert("Ingresar los datos correctamente")
            }

      
    }

    function Limpiar(){

       document.getElementById("cbMedicos").value="";
       document.getElementById("fechaAtencion").value="";
       document.getElementById("Cupos").value="";
       document.getElementById("horaInicio").value="";
       document.getElementById("horaFin").value="";
    }
    /*enviando datos en formulario*/

    function CrearHorarioMedico(event){

         RegistrarHorario()
        event.preventDefault();
    }
    
    /*editar horario*/
    async function GuardarCambios(event){
            
     var IdHorarioActualizar=document.getElementById("txtIdHorario").value
       
    
    
     var HorarioAtencion=document.getElementById("txtHorarioAtencion").value;
     var HorarioInicio=document.getElementById("txtHorarioInicio").value;
     var HorarioFin=document.getElementById("txtHoraFin").value;
     var Cupos=document.getElementById("txtCupos").value

     var newHorario={
        HorarioAtencion,
        HorarioInicio,
        HorarioFin,
        Cupos
     }

     var data=await fetch(`http://localhost:5000/api/Horario/${IdHorarioActualizar}`,{
       method: "PUT",
        body: JSON.stringify(newHorario),
        headers: {
            "Content-Type": "application/json"
        }   
     })

    var resultUpdate=await data.json();
     
   
       
     if(resultUpdate.id>0){
        
         alert(resultUpdate.mensaje)
         CargarHtmlHorarios()
         showView("citas")
         modalEditarHorario.hide()

     }
     else {
        alert(resultUpdate.error)
     }
 

        event.preventDefault();
    
    }

    

 
  
</script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.min.js" integrity="sha384-G/EV+4j2dNv+tEPo3++6LCgdCROaejBqfUeNjuKAiuXbjrxilcCdDz6ZAVfHWe1Y" crossorigin="anonymous"></script>
</body>
</html>